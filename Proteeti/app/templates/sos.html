{% extends "base.html" %}

{% block content %}
<div class="text-center">
    <h2>Emergency SOS</h2>
    <p class="text-muted">Click the button to send your location and record audio for 2 minutes.</p>

    <button id="sosBtn" class="btn btn-danger btn-lg mt-3 p-4 fs-3" style="background-color: #8b0606; border-color: #8B0000; border-radius: 15px; min-width: 200px;">
        ðŸš¨ SEND SOS NOW
    </button>
    
    <div id="status" class="mt-3"></div>
    <div id="timer" class="mt-2" style="font-size: 20px; font-weight: bold; display: none;"></div>
    <div id="result" class="mt-3"></div>
</div>

<script>
let mediaRecorder;
let recordedAudioChunks = [];

document.getElementById('sosBtn').addEventListener('click', async function() {
    document.getElementById('sosBtn').disabled = true;
    document.getElementById('status').innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Getting location...</div>';
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            console.log('[SOS] Location:', lat, lng, 'Accuracy:', accuracy, 'm');
            
            try {
                // Step 1: Send location immediately WITH accuracy
                const locationResponse = await fetch('/send_sos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng, accuracy: accuracy })
                });
                
                const locationResult = await locationResponse.json();
                
                if (!locationResponse.ok) {
                    document.getElementById('status').innerHTML = 
                        '<div class="alert alert-danger">Error sending location: ' + locationResult.error + '</div>';
                    document.getElementById('sosBtn').disabled = false;
                    return;
                }
                
                console.log('[SOS] Location sent, starting audio recording');
                document.getElementById('status').innerHTML = 
                    '<div class="alert alert-success"><i class="fas fa-check"></i> Location sent! Recording audio...</div>';
                
                // Step 2: Start recording audio for 2 minutes
                await startAudioRecording();
                
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    '<div class="alert alert-danger">Error: ' + error.message + '</div>';
                document.getElementById('sosBtn').disabled = false;
            }
        },
        (error) => {
            document.getElementById('status').innerHTML = 
                '<div class="alert alert-danger">Location unavailable. Please enable GPS.</div>';
            document.getElementById('sosBtn').disabled = false;
        },
        { 
            enableHighAccuracy: true, 
            timeout: 20000,
            maximumAge: 0
        }
    );
});

async function startAudioRecording() {
    try {
        console.log('[SOS] Requesting microphone access');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        console.log('[SOS] Microphone access granted, starting recording');
        document.getElementById('timer').style.display = 'block';
        document.getElementById('timer').innerHTML = 'Recording: 0s / 120s';
        
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        recordedAudioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedAudioChunks.push(event.data);
                console.log('[SOS] Audio chunk saved:', event.data.size, 'bytes');
            }
        };
        
        mediaRecorder.start();
        
        // Timer for 2 minutes (120 seconds)
        let seconds = 0;
        const timerInterval = setInterval(() => {
            seconds++;
            document.getElementById('timer').innerHTML = `Recording: ${seconds}s / 120s`;
            
            if (seconds >= 120) {
                clearInterval(timerInterval);
                console.log('[SOS] 2 minutes elapsed, stopping recording');
                mediaRecorder.stop();
                
                // Stop audio stream
                stream.getTracks().forEach(track => {
                    track.stop();
                    console.log('[SOS] Audio track stopped');
                });
                
                // Send audio
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(recordedAudioChunks, { type: 'audio/webm' });
                    console.log('[SOS] Audio blob created:', audioBlob.size, 'bytes');
                    await sendAudio(audioBlob);
                };
            }
        }, 1000);
        
    } catch (error) {
        console.error('[SOS] Microphone error:', error);
        let errorMsg = 'Cannot access microphone: ' + error.message;
        
        if (error.name === 'NotAllowedError') {
            errorMsg = 'Microphone permission denied. Please enable it in settings.';
        }
        
        document.getElementById('status').innerHTML = 
            '<div class="alert alert-danger">' + errorMsg + '</div>';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('sosBtn').disabled = false;
    }
}

async function sendAudio(audioBlob) {
    try {
        console.log('[SOS] Sending audio to server');
        document.getElementById('timer').style.display = 'none';
        document.getElementById('status').innerHTML = 
            '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Sending audio...</div>';
        
        const formData = new FormData();
        formData.append('audio', audioBlob, 'emergency_audio.webm');
        
        const response = await fetch('/send_sos_audio', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            document.getElementById('status').innerHTML = 
                '<div class="alert alert-success"><i class="fas fa-check-circle"></i> <strong>SOS Complete!</strong><br/>Location and audio sent to trusted contacts.</div>';
            document.getElementById('result').innerHTML = 
                '<p>Audio size: ' + (audioBlob.size / 1024).toFixed(2) + ' KB</p>';
        } else {
            document.getElementById('status').innerHTML = 
                '<div class="alert alert-warning"><i class="fas fa-exclamation"></i> Location was sent, but audio failed: ' + result.error + '</div>';
        }
    } catch (error) {
        console.error('[SOS] Error sending audio:', error);
        document.getElementById('status').innerHTML = 
            '<div class="alert alert-warning"><i class="fas fa-exclamation"></i> Location was sent, but audio failed: ' + error.message + '</div>';
    } finally {
        document.getElementById('sosBtn').disabled = false;
        recordedAudioChunks = [];
    }
}
</script>
{% endblock %}
