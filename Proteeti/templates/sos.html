{% extends "base.html" %}
{% block content %}
<div class="text-center">
<h2>Emergency SOS</h2>
<p class="text-muted">Click the button to send your location and record audio for 2 minutes.</p>
<button id="sosBtn" class="btn btn-danger btn-lg mt-3 p-4 fs-3" style="background-color: #8b0606; border-color: #8B0000; border-radius: 15px; min-width: 200px;">
    ðŸš¨ SEND SOS NOW
</button>
<button id="stopBtn" class="btn btn-secondary btn-lg mt-4 p-3 fs-4"
            style="border-radius: 12px; min-width: 160px; display: none;">
        ðŸ›‘ STOP RECORDING
</button>

<div id="status" class="mt-3"></div>
<div id="timer" class="mt-2" style="font-size: 20px; font-weight: bold; display: none;"></div>
<div id="result" class="mt-3"></div>
</div>
<script>


let mediaRecorder;
let recordedAudioChunks = [];
let recordingActive = false;
let timerInterval = null;
let stream = null;

document.getElementById('sosBtn').addEventListener('click', async function() {
    this.disabled = true;
    document.getElementById('sosBtn').disabled = true;
    document.getElementById('status').innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Getting location...</div>';

    if (!navigator.geolocation) {
        document.getElementById('status').innerHTML =
            '<div class="alert alert-danger">Location unavailable. Please enable device location.</div>';
        this.disabled = false;
        return;
    }

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            console.log('[SOS] Location:', lat, lng, 'Accuracy:', accuracy, 'm');

           

            try {
                // Step 1: Send location immediately WITH accuracy
                const locationResponse = await fetch('/send_sos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng, accuracy: accuracy })
                });

                const locationResult = await locationResponse.json();

                if (!locationResponse.ok) {
                    document.getElementById('status').innerHTML =
                        '<div class="alert alert-danger">Error sending location: ' + locationResult.error + '</div>';
                    document.getElementById('sosBtn').disabled = false;
                    return;
                }

                document.getElementById('status').innerHTML =
                    '<div class="alert alert-success"><i class="fas fa-check"></i> Location sent! Recording audio...</div>';
                await startAudioRecording();

                console.log('[SOS] Location sent, starting audio recording');
                document.getElementById('status').innerHTML =
                    '<div class="alert alert-success"><i class="fas fa-check"></i> Location sent! Recording audio...</div>';
                await startAudioRecording();

            } catch (error) {
                document.getElementById('status').innerHTML =
                    '<div class="alert alert-danger">Error: ' + error.message + '</div>';
                document.getElementById('sosBtn').disabled = false;
            }
        },
        (error) => {
            let errorMsg = 'Location unavailable. ';
            if (error.code === 1) errorMsg += 'Permission denied. Please enable device location.';
            else if (error.code === 2) errorMsg += 'Position unavailable. Try moving to an open area.';
            else if (error.code === 3) errorMsg += 'Timeout. Try again in a moment.';
            document.getElementById('status').innerHTML =
                '<div class="alert alert-danger">' + errorMsg + '</div>';
            document.getElementById('sosBtn').disabled = false;
        },
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
    );
});


document.getElementById('stopBtn').addEventListener('click', function() {
    if (!mediaRecorder || !recordingActive) return;


    recordingActive = false;
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    document.getElementById('stopBtn').style.display = 'none';
    clearInterval(timerInterval);
    document.getElementById('timer').style.display = 'none';
    mediaRecorder.stop();
});


async function startAudioRecording() {
    try {
        console.log('[SOS] Requesting microphone access');
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        document.getElementById('timer').style.display = 'block';
        document.getElementById('timer').innerHTML = 'Recording: 0s / 120s';
        document.getElementById('stopBtn').style.display = 'inline-block';

        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        recordedAudioChunks = [];
        recordingActive = true;

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedAudioChunks.push(event.data);
                console.log('[SOS] Audio chunk saved:', event.data.size, 'bytes');
            }
        };

        mediaRecorder.onstop = async () => {

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            const audioBlob = new Blob(recordedAudioChunks, { type: 'audio/webm' });
            await sendAudio(audioBlob);
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('timer').style.display = 'none';
            recordingActive = false;
        };


        // Timer for 2 minutes (120 seconds)
        let seconds = 0;
        timerInterval = setInterval(() => {
            seconds++;
            document.getElementById('timer').innerHTML = `Recording: ${seconds}s / 120s`;

            if (seconds >= 120) {

                if (recordingActive) {
                    recordingActive = false;
                    clearInterval(timerInterval);
                    timerInterval = null;
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('timer').style.display = 'none';
                    mediaRecorder.stop();
                }
            }
        }, 1000);

        mediaRecorder.start();

    } catch (error) {
        console.error('[SOS] Microphone error:', error);
        let errorMsg = 'Cannot access microphone: ' + error.message;
        if (error.name === 'NotAllowedError') {
            errorMsg = 'Microphone permission denied. Please enable it in settings.';
        }
        document.getElementById('status').innerHTML =
            '<div class="alert alert-danger">' + errorMsg + '</div>';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('sosBtn').disabled = false;
        document.getElementById('stopBtn').style.display = 'none';
    }
}

async function sendAudio(audioBlob) {
    try {
        console.log('[SOS] Sending audio to server');
        document.getElementById('timer').style.display = 'none';
        document.getElementById('status').innerHTML =
            '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Sending audio...</div>';

        const formData = new FormData();
        formData.append('audio', audioBlob, 'emergency_audio.webm');

        const response = await fetch('/send_sos_audio', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            document.getElementById('status').innerHTML =
                '<div class="alert alert-success"><i class="fas fa-check-circle"></i> <strong>SOS Complete!</strong><br/>Location and audio sent to trusted contacts.</div>';
            document.getElementById('result').innerHTML =
                '<p>Audio size: ' + (audioBlob.size / 1024).toFixed(2) + ' KB</p>';
        } else {
            document.getElementById('status').innerHTML =
                '<div class="alert alert-warning"><i class="fas fa-exclamation"></i> Location was sent, but audio failed: ' + result.error + '</div>';
        }
    } catch (error) {
        console.error('[SOS] Error sending audio:', error);
        document.getElementById('status').innerHTML =
            '<div class="alert alert-warning"><i class="fas fa-exclamation"></i> Location was sent, but audio failed: ' + error.message + '</div>';
    } finally {
        document.getElementById('sosBtn').disabled = false;
        recordedAudioChunks = [];
    }
}
</script>
{% endblock %}

