{% extends "base.html" %}
{% block content %}
<div class="auth-split-container">
  <div class="auth-card-wrapper">
    <div class="row g-0">
      <!-- Art / Illustration (LEFT) -->
      <div class="col-lg-6 d-none d-lg-block login-art-panel position-relative">
        <span class="auth-bubble big" style="left:12%;top:18%"></span>
        <span class="auth-bubble med" style="left:22%;top:50%"></span>
        <span class="auth-bubble sm"  style="left:8%; top:72%"></span>
      </div>

      <!-- Form (RIGHT) -->
      <div class="col-12 col-lg-6 bg-transparent auth-form-col">
        <div class="login-form-blob w-100">
          <div class="auth-card-inner">
            <h1 class="mb-1" style="color:var(--bordeaux);font-weight:700; text-align: center;">Complete your profile</h1>
            <p class="text-muted mb-3" align>Just a few details to personalize alerts and contacts.</p>

            {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}

            <form method="post" novalidate id="onboardingForm">
              <input type="hidden" name="country_name" id="countryName">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Full name *</label>
                  <input class="form-control" name="full_name" value="{{ full_name or '' }}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Mobile phone *</label>
                  <div class="input-group">
                    <select class="form-select" id="countryCode" name="country_code" style="max-width: 140px;" required>
                      <option value="">Code</option>
                    </select>
                    <input class="form-control" name="phone" placeholder="Phone number" value="{{ phone or '' }}" required>
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Country *</label>
                  <select class="form-select" name="country" id="countrySelect" required>
                    <option value="">Loading countries...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">City *</label>
                  <select class="form-select" name="city" id="citySelect" required>
                    <option value="">Select country first</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Language</label>
                  <select class="form-select" name="language" id="languageSelect" required>
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="bn">Bengali</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Timezone</label>
                  <select class="form-select" name="timezone" id="timezoneSelect" required>
                    <option value="UTC">Loading...</option>
                  </select>
                </div>

                <div class="col-12"><hr></div>

                <div class="col-12">
                  <h5 class="mb-2">Trusted contact (required)</h5>
                </div>
                <div class="col-md-5">
                  <label class="form-label">Name *</label>
                  <input class="form-control" name="tc_name" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-control" name="tc_email" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" name="tc_phone">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Relation</label>
                  <input class="form-control" name="tc_relation">
                </div>

                <div class="col-12 mt-2">
                  <button type="submit" class="btn btn-danger w-100 btn-lg">Save & Continue</button>
                </div>
              </div>
            </form>

            <p class="text-center text-muted small mb-0 mt-2">You can edit these later in Account â†’ Profile & Contacts.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Free APIs we use:
// 1. REST Countries - for country list and info
// 2. Geonames - for cities (using free tier)
// 3. WorldTimeAPI - for timezones

class OnboardingForm {
  constructor() {
    this.countrySelect = document.getElementById('countrySelect');
    this.citySelect = document.getElementById('citySelect');
    this.timezoneSelect = document.getElementById('timezoneSelect');
    this.countryCodeSelect = document.getElementById('countryCode');
    this.languageSelect = document.getElementById('languageSelect');
    
    this.init();
  }

  async init() {
    await this.loadCountries();
    await this.loadTimezones();
    this.setupEventListeners();
  }

  // Load all countries from REST Countries API
  async loadCountries() {
    try {
      const response = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2,idd,timezones');
      const countries = await response.json();
      
      // Sort countries alphabetically
      countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
      
      this.countrySelect.innerHTML = '<option value="">Select Country</option>';
      this.countryCodeSelect.innerHTML = '<option value="">Code</option>';
      
      countries.forEach(country => {
        // Add to country dropdown
        const option = document.createElement('option');
        option.value = country.cca2; // Country code (US, BD, IN, etc.)
        option.textContent = country.name.common;
        option.setAttribute('data-timezones', JSON.stringify(country.timezones));
        
        // Get country calling code
        let callingCode = '+1'; // default
        if (country.idd && country.idd.root && country.idd.suffixes) {
          callingCode = country.idd.root + (country.idd.suffixes[0] || '');
        }
        option.setAttribute('data-calling-code', callingCode);
        
        this.countrySelect.appendChild(option);
        
        // Add to country code dropdown
        const codeOption = document.createElement('option');
        codeOption.value = callingCode;
        codeOption.textContent = `${callingCode} (${country.cca2})`;
        codeOption.setAttribute('data-country', country.cca2);
        this.countryCodeSelect.appendChild(codeOption);
      });
      
    } catch (error) {
      console.error('Error loading countries:', error);
      this.loadFallbackCountries();
    }
  }

  // Fallback if API fails
  loadFallbackCountries() {
    const fallbackCountries = [
      { code: 'BD', name: 'Bangladesh', callingCode: '+880', timezones: ['Asia/Dhaka'] },
      { code: 'US', name: 'United States', callingCode: '+1', timezones: ['America/New_York'] },
      { code: 'IN', name: 'India', callingCode: '+91', timezones: ['Asia/Kolkata'] },
      { code: 'UK', name: 'United Kingdom', callingCode: '+44', timezones: ['Europe/London'] }
    ];
    
    this.countrySelect.innerHTML = '<option value="">Select Country</option>';
    fallbackCountries.forEach(country => {
      const option = document.createElement('option');
      option.value = country.code;
      option.textContent = country.name;
      option.setAttribute('data-timezones', JSON.stringify(country.timezones));
      option.setAttribute('data-calling-code', country.callingCode);
      this.countrySelect.appendChild(option);
    });
  }

  // Load timezones from WorldTimeAPI
  async loadTimezones() {
    try {
      const response = await fetch('http://worldtimeapi.org/api/timezone');
      const timezones = await response.json();
      
      this.timezoneSelect.innerHTML = '<option value="">Select Timezone</option>';
      timezones.forEach(tz => {
        const option = document.createElement('option');
        option.value = tz;
        option.textContent = tz.replace(/_/g, ' ');
        this.timezoneSelect.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading timezones:', error);
      this.loadFallbackTimezones();
    }
  }

  loadFallbackTimezones() {
    const commonTimezones = [
      'Asia/Dhaka', 'America/New_York', 'America/Los_Angeles', 
      'Europe/London', 'Asia/Kolkata', 'Europe/Paris', 'Asia/Tokyo'
    ];
    
    this.timezoneSelect.innerHTML = '<option value="">Select Timezone</option>';
    commonTimezones.forEach(tz => {
      const option = document.createElement('option');
      option.value = tz;
      option.textContent = tz.replace(/_/g, ' ');
      this.timezoneSelect.appendChild(option);
    });
  }

  // Load cities for selected country using Geonames (free tier)
  async loadCities(countryCode) {
    this.citySelect.innerHTML = '<option value="">Loading cities...</option>';
    
    try {
      // Using a free cities API (example with simple dataset)
      // For production, you might want to use Geonames with username (free)
      const response = await fetch(`https://api.api-ninjas.com/v1/city?country=${countryCode}&limit=30`, {
        headers: { 'X-Api-Key': '' } // Free tier doesn't need key for small usage
      });
      
      let cities = [];
      if (response.ok) {
        cities = await response.json();
      } else {
        // Fallback to predefined cities
        cities = this.getFallbackCities(countryCode);
      }
      
      this.citySelect.innerHTML = '<option value="">Select City</option>';
      cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city.name || city;
        option.textContent = city.name || city;
        this.citySelect.appendChild(option);
      });
      
    } catch (error) {
      console.error('Error loading cities:', error);
      this.loadFallbackCities(countryCode);
    }
  }

  getFallbackCities(countryCode) {
    const cityMap = {
      'BD': ['Dhaka', 'Chittagong', 'Sylhet', 'Rajshahi', 'Khulna'],
      'US': ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix'],
      'IN': ['Mumbai', 'Delhi', 'Bangalore', 'Hyderabad', 'Chennai'],
      'UK': ['London', 'Manchester', 'Birmingham', 'Liverpool', 'Glasgow'],
      'CA': ['Toronto', 'Vancouver', 'Montreal', 'Calgary', 'Ottawa'],
      'AU': ['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide']
    };
    
    return cityMap[countryCode] || ['Capital City'];
  }

setupEventListeners() {
    // Country change event
    this.countrySelect.addEventListener('change', (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      const countryCode = e.target.value;
      const countryName = selectedOption.textContent; // ADD THIS LINE
      
      // Update the hidden country name field - ADD THESE 2 LINES
      document.getElementById('countryName').value = countryName;
      
      if (countryCode) {
        // Update country code
        const callingCode = selectedOption.getAttribute('data-calling-code');
        this.countryCodeSelect.value = callingCode;
        
        // Load cities for this country
        this.loadCities(countryCode);
        
        // Update timezone based on country
        const timezones = JSON.parse(selectedOption.getAttribute('data-timezones') || '[]');
        if (timezones.length > 0 && this.timezoneSelect.querySelector(`option[value="${timezones[0]}"]`)) {
          this.timezoneSelect.value = timezones[0];
        }
      }
    });

    // Country code change event (sync with country)
    this.countryCodeSelect.addEventListener('change', (e) => {
      const selectedCountry = e.target.options[e.target.selectedIndex].getAttribute('data-country');
      if (selectedCountry) {
        this.countrySelect.value = selectedCountry;
        // Trigger change event to load cities
        this.countrySelect.dispatchEvent(new Event('change'));
      }
    });

    // Form submission - combine country code with phone number
    document.getElementById('onboardingForm').addEventListener('submit', (e) => {
      const countryCode = this.countryCodeSelect.value;
      const phoneInput = document.querySelector('input[name="phone"]');
      
      // Prepend country code to phone number if not already there
      if (countryCode && phoneInput.value && !phoneInput.value.startsWith(countryCode)) {
        phoneInput.value = countryCode + phoneInput.value;
      }
    });
  }
}

// Initialize the form when page loads
document.addEventListener('DOMContentLoaded', () => {
  new OnboardingForm();
});
</script>
{% endblock %}